#!/bin/sh

PASS_DIR="${PASSWORD_STORE_DIR:-$HOME/.password-store}"

show_menu() {
    printf "Copy Password\nAdd Password\nDelete Password\n" | dmenu -c -i -l 3 -p "Pass:"
}

list_passwords() {
    find "$PASS_DIR" -name "*.gpg" -type f 2>/dev/null | \
        sed "s|$PASS_DIR/||g" | \
        sed 's|\.gpg$||g' | \
        sort
}

copy_password() {
    selected=$(list_passwords | dmenu -c -i -l 10 -p "Select key:")
    [ -z "$selected" ] && return

    password=$(printf "" | dmenu -c -i -P -p "Password:" </dev/null)
    [ -z "$password" ] && return

    printf "%s" "$password" | xclip -selection clipboard
    notify-send "Password copied" "Clipboard will clear in 45 seconds"
}

add_password() {
    entry=$(dmenu -c -i -p "Password name:" </dev/null)
    [ -z "$entry" ] && return

    password=$(printf "" | dmenu -c -i -P -p "Password:" </dev/null)
    [ -z "$password" ] && return

    printf "%s\n" "$password" | pass insert -ef "$entry"
    [ $? -eq 0 ] && notify-send "Password added" "$entry"
}

delete_password() {
    selected=$(list_passwords | dmenu -c -i -l 10 -p "Delete:")
    [ -z "$selected" ] && return

    confirm=$(printf "no\nyes" | dmenu -c -i -l 2 -p "Delete $selected?")
    [ "$confirm" = "yes" ] && pass rm -f "$selected" && notify-send "Password deleted" "$selected"
}

case $(show_menu) in
    "Copy Password")
        copy_password
        ;;
    "Add Password")
        add_password
        ;;
    "Delete Password")
        delete_password
        ;;
esac
