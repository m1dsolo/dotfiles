#!/bin/sh

# Shows GPU memory usage.
# For dwm/st status bar, compatible with Arch Linux Nerd Fonts rendering

case $BUTTON in
	1) notify-send "󰾮 GPU hogs" "$(nvidia-smi --query-gpu=pid,process_name,used_memory --format=csv,noheader,nounits | sort -rnk3 | head -10)" ;;
	2) "$TERMINAL" -e "$EDITOR" "$0" ;;
    3) setsid -f "$TERMINAL" -e nvidia-smi ;;
esac

command -v nvidia-smi >/dev/null 2>&1 || exit 1
nvidia-smi -L >/dev/null 2>&1 || exit 1

gpu_mem=$(nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits)
[ -z "$gpu_mem" ] && exit 1

echo "$gpu_mem" | awk -F ', ' '{
    used = $1
    total = $2
    pct = int(used * 100 / total)
    printf ("%d%%󰾮\n", pct)
}'
